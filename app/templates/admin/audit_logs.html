{% extends "base.html" %}

{% block title %}Audit Logs - Admin Panel{% endblock %}

{% block styles %}
<style>
    .user-status-card {
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        margin-bottom: 10px;
        border-left: 4px solid transparent;
    }
    
    .user-status-card.online {
        border-left-color: #28a745;
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
    }
    
    .user-status-card.offline {
        border-left-color: #dc3545;
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
    }
    
    .user-status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }
    
    .status-indicator.online {
        background-color: #28a745;
    }
    
    .status-indicator.offline {
        background-color: #dc3545;
        animation: none;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    
    .location-btn {
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }
    
    .location-btn:hover {
        transform: scale(1.05);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .refresh-btn {
        position: relative;
        overflow: hidden;
    }
    
    .refresh-btn.loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    /* Dark theme compatibility */
    html[data-theme="dark"] .user-status-card {
        background-color: #2d3748;
        border: 1px solid #4a5568;
    }
    
    html[data-theme="dark"] .user-status-card.online {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.2), rgba(40, 167, 69, 0.1));
    }
    
    html[data-theme="dark"] .user-status-card.offline {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.2), rgba(220, 53, 69, 0.1));
    }
    
    /* Neon theme compatibility */
    html[data-theme="neon-dark"] .user-status-card {
        background: var(--neon-glass-bg) !important;
        border: 1px solid var(--neon-border) !important;
        backdrop-filter: blur(15px) !important;
    }
    
    html[data-theme="neon-dark"] .user-status-card:hover {
        border-color: var(--neon-accent-primary) !important;
        box-shadow: var(--neon-glow) !important;
    }
    
    html[data-theme="neon-dark"] .stats-card {
        background: var(--neon-glass-bg) !important;
        border: 1px solid var(--neon-border) !important;
        backdrop-filter: blur(15px) !important;
        color: var(--neon-text-primary) !important;
    }
    
    /* Neon theme for updated badge and refresh button */
    html[data-theme="neon-dark"] .card-header {
        background: var(--neon-glass-bg) !important;
        border: 1px solid var(--neon-border) !important;
        backdrop-filter: blur(15px) !important;
    }
    
    html[data-theme="neon-dark"] .refresh-btn {
        background: var(--neon-glass-bg) !important;
        border: 1px solid var(--neon-border) !important;
        color: var(--neon-text-primary) !important;
        backdrop-filter: blur(10px) !important;
    }
    
    html[data-theme="neon-dark"] .refresh-btn:hover {
        border-color: var(--neon-accent-primary) !important;
        box-shadow: var(--neon-glow) !important;
        color: var(--neon-accent-primary) !important;
    }
    
    html[data-theme="neon-dark"] .badge.bg-light {
        background: var(--neon-glass-bg) !important;
        border: 1px solid var(--neon-border) !important;
        color: var(--neon-text-primary) !important;
        backdrop-filter: blur(10px) !important;
    }
    
    html[data-theme="neon-dark"] #lastUpdated {
        background: var(--neon-glass-bg) !important;
        border: 1px solid var(--neon-border) !important;
        color: var(--neon-text-primary) !important;
        backdrop-filter: blur(10px) !important;
    }
    
    /* Neon theme for audit logs table */
    html[data-theme="neon-dark"] .table {
        color: var(--neon-text-primary) !important;
    }
    
    html[data-theme="neon-dark"] .table th {
        border-color: var(--neon-border) !important;
        color: var(--neon-text-primary) !important;
    }
    
    html[data-theme="neon-dark"] .table td {
        border-color: var(--neon-border) !important;
        color: var(--neon-text-primary) !important;
    }
    
    html[data-theme="neon-dark"] .table-striped > tbody > tr:nth-of-type(odd) > td {
        background-color: rgba(var(--neon-accent-rgb), 0.1) !important;
    }
    
    html[data-theme="neon-dark"] .card {
        background: var(--neon-glass-bg) !important;
        border: 1px solid var(--neon-border) !important;
        backdrop-filter: blur(15px) !important;
    }
    
    html[data-theme="neon-dark"] .card-body {
        color: var(--neon-text-primary) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- Real-time User Activity Section -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-people-fill me-2"></i>
                        Real-time User Activity
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-light btn-sm refresh-btn" id="refreshUsersBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                        <span class="badge bg-light text-dark" id="lastUpdated">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- User Activity Filters -->
                <div class="row mb-3">
                    <div class="col-12">
                        <form id="userActivityFilters" class="row g-2">
                            <div class="col-md-3">
                                <label for="statusFilter" class="form-label">Status</label>
                                <select class="form-select form-select-sm" id="statusFilter" name="status">
                                    <option value="all">All Users</option>
                                    <option value="online">Online Only</option>
                                    <option value="offline">Offline Only</option>
                                </select>
                            </div>
                            {% if current_user.role.name == 'SUPER_USER' %}
                            <div class="col-md-3">
                                <label for="branchFilterUsers" class="form-label">Branch</label>
                                <select class="form-select form-select-sm" id="branchFilterUsers" name="branch_id">
                                    <option value="">All Branches</option>
                                    {% for branch in branches %}
                                    <option value="{{ branch.id }}">{{ branch.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            <div class="col-md-3">
                                <label for="roleFilter" class="form-label">Role</label>
                                <select class="form-select form-select-sm" id="roleFilter" name="role">
                                    <option value="all">All Roles</option>
                                    <option value="super_user">Super User</option>
                                    <option value="branch_admin">Branch Admin</option>
                                    <option value="cashier">Cashier</option>
                                    <option value="waiter">Waiter</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-primary btn-sm w-100" id="applyUserFilters">
                                    <i class="bi bi-funnel me-1"></i>Apply Filters
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Statistics Row -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="stats-card bg-success">
                            <div class="stats-number" id="onlineCount">0</div>
                            <div>Online Users</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card bg-danger">
                            <div class="stats-number" id="offlineCount">0</div>
                            <div>Offline Users</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card bg-info">
                            <div class="stats-number" id="totalCount">0</div>
                            <div>Total Users</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card bg-warning">
                            <div class="stats-number" id="locationCount">0</div>
                            <div>With Location</div>
                        </div>
                    </div>
                </div>
                
                <!-- Users Grid -->
                <div class="row" id="usersGrid">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading users...</span>
                        </div>
                        <p class="mt-2">Loading user activity data...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <h1>Audit Logs</h1>
        
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="logsFilterForm" class="row g-3">
                    {% if current_user.role.name == 'SUPER_USER' %}
                    <div class="col-md-2">
                        <label for="branchFilter" class="form-label">Branch</label>
                        <select class="form-select" id="branchFilter" name="branch_id">
                            <option value="">All Branches</option>
                            {% for branch in branches %}
                            <option value="{{ branch.id }}" {% if filters.branch_id == branch.id %}selected{% endif %}>
                                {{ branch.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="col-md-3">
                        <label for="userFilter" class="form-label">User</label>
                        <select class="form-select" id="userFilter" name="user_id">
                            <option value="">All Users</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if filters.user_id == user.id|string() %}selected{% endif %}>
                                {{ user.username }} ({{ user.get_full_name() }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="actionFilter" class="form-label">Action</label>
                        <select class="form-select" id="actionFilter" name="action">
                            <option value="">All Actions</option>
                            {% for action in actions %}
                            <option value="{{ action }}" {% if filters.action == action %}selected{% endif %}>
                                {{ action.replace('_', ' ').title() }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="dateFrom" class="form-label">From</label>
                        <input type="date" class="form-control" id="dateFrom" name="date_from" 
                               value="{{ filters.date_from or '' }}">
                    </div>
                    <div class="col-md-2">
                        <label for="dateTo" class="form-label">To</label>
                        <input type="date" class="form-control" id="dateTo" name="date_to" 
                               value="{{ filters.date_to or '' }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="btn-group w-100" role="group">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-funnel"></i> Filter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clearFilters">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User</th>
                                {% if current_user.role.name == 'SUPER_USER' %}
                                <th>Branch</th>
                                <th>Role</th>
                                {% endif %}
                                <th>Action</th>
                                <th>Description</th>
                                <th>IP Address</th>
                                <th>Date/Time</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            {% for log in logs.items %}
                            <tr>
                                <td>
                                    <div>{{ log.user.username if log.user else 'System' }}</div>
                                    <small class="text-muted">{{ log.user.get_full_name() if log.user else '' }}</small>
                                </td>
                                {% if current_user.role.name == 'SUPER_USER' %}
                                <td>
                                    {% if log.user and log.user.branch %}
                                        <span class="badge bg-secondary">{{ log.user.branch.name }}</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if log.user %}
                                        {% if log.user.role.value == 'super_user' %}
                                            <span class="badge bg-danger">Super User</span>
                                        {% elif log.user.role.value == 'branch_admin' %}
                                            <span class="badge bg-primary">Branch Admin</span>
                                        {% elif log.user.role.value == 'cashier' %}
                                            <span class="badge bg-success">Cashier</span>
                                        {% elif log.user.role.value == 'waiter' %}
                                            <span class="badge bg-info">Waiter</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ log.user.role.value.replace('_', ' ').title() }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td>
                                    <span class="badge bg-{{ 'success' if log.action == 'login' else 'danger' if log.action == 'logout' else 'warning' if log.action == 'ORDER_EDITED' else 'primary' }}">
                                        {% if log.action == 'ORDER_EDITED' %}
                                            <i class="bi bi-pencil-square me-1"></i>
                                        {% endif %}
                                        {{ log.action.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td>{{ log.description or '' }}</td>
                                <td>{{ log.ip_address or 'N/A' }}</td>
                                <td>
                                    <div>{{ log.created_at | local_datetime_short }}</div>
                                    <small class="text-muted">{{ log.created_at | local_datetime_short }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Logs pagination" id="logsPagination">
                    <ul class="pagination justify-content-center">
                        {% if logs.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="{{ logs.prev_num }}">Previous</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                        {% endif %}
                        
                        {% for page_num in logs.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != logs.page %}
                                <li class="page-item">
                                    <a class="page-link" href="#" data-page="{{ page_num }}">{{ page_num }}</a>
                                </li>
                                {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if logs.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="{{ logs.next_num }}">Next</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set global variable for superuser check
window.isSuperUser = {% if current_user.role.name == 'SUPER_USER' %}true{% else %}false{% endif %};

// Prevent multiple simultaneous requests
let isLoadingLogs = false;

document.addEventListener('DOMContentLoaded', function() {
    // Load initial logs
    loadLogs(1);

    // Handle form submission with AJAX
    document.getElementById('logsFilterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadLogs(1);
    });
    
    // Clear filters
    document.getElementById('clearFilters').addEventListener('click', function() {
        document.getElementById('logsFilterForm').reset();
        loadLogs(1);
    });
    
    // Handle pagination clicks
    document.getElementById('logsPagination').addEventListener('click', function(e) {
        if (e.target.tagName === 'A' && e.target.dataset.page) {
            e.preventDefault();
            if (!isLoadingLogs) {
                loadLogs(parseInt(e.target.dataset.page));
            }
        }
    });
    
    // Load logs with AJAX
    function loadLogs(page = 1) {
        // Prevent multiple simultaneous requests
        if (isLoadingLogs) {
            return;
        }
        isLoadingLogs = true;
        
        const formData = new FormData(document.getElementById('logsFilterForm'));
        const params = new URLSearchParams();
        for (const [key, value] of formData) {
            if (value) {
                params.append(key, value);
            }
        }
        params.append('page', page);
        params.append('per_page', 10);
        
        fetch(`{% if current_user.role.name == 'SUPER_USER' %}{{ url_for('superuser.audit_logs') }}{% else %}{{ url_for('admin.audit_logs') }}{% endif %}?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Update table body
            const tableBody = document.getElementById('logsTableBody');
            tableBody.innerHTML = '';
            
            data.logs.forEach(log => {
                const row = document.createElement('tr');
                
                // Determine badge class based on action
                let badgeClass = 'bg-primary';
                let actionIcon = '';
                if (log.action === 'login') {
                    badgeClass = 'bg-success';
                } else if (log.action === 'logout') {
                    badgeClass = 'bg-danger';
                } else if (log.action === 'ORDER_EDITED') {
                    badgeClass = 'bg-warning';
                    actionIcon = '<i class="bi bi-pencil-square me-1"></i>';
                }
                
                // Format action text with proper title case
                let actionText = log.action.replace(/_/g, ' ');
                actionText = actionText.charAt(0).toUpperCase() + actionText.slice(1);
                
                // Format role badge
                let roleBadge = '<span class="text-muted">N/A</span>';
                if (log.user.role && log.user.role !== 'N/A') {
                    switch(log.user.role) {
                        case 'super_user':
                            roleBadge = '<span class="badge bg-danger">Super User</span>';
                            break;
                        case 'branch_admin':
                            roleBadge = '<span class="badge bg-primary">Branch Admin</span>';
                            break;
                        case 'cashier':
                            roleBadge = '<span class="badge bg-success">Cashier</span>';
                            break;
                        case 'waiter':
                            roleBadge = '<span class="badge bg-info">Waiter</span>';
                            break;
                        default:
                            roleBadge = `<span class="badge bg-secondary">${log.user.role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>`;
                    }
                }
                
                // Check if user is superuser to include branch and role columns
                const isSuperUser = window.isSuperUser;
                
                let branchRoleColumns = '';
                if (isSuperUser) {
                    branchRoleColumns = `
                        <td><span class="badge bg-secondary">${log.user.branch_name || 'N/A'}</span></td>
                        <td>${roleBadge}</td>
                    `;
                }
                
                row.innerHTML = `
                    <td>
                        <div>${log.user.username}</div>
                        <small class="text-muted">${log.user.full_name}</small>
                    </td>
                    ${branchRoleColumns}
                    <td>
                        <span class="badge ${badgeClass}">
                            ${actionIcon}${actionText}
                        </span>
                    </td>
                    <td>${log.description}</td>
                    <td>${log.ip_address}</td>
                    <td>
                        <div>${log.created_at.date}</div>
                        <small class="text-muted">${log.created_at.time}</small>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update pagination
            updatePagination(data.pagination);
            
            // Reset loading flag
            isLoadingLogs = false;
        })
        .catch(error => {
            console.error('Error loading logs:', error);
            // Reset loading flag on error too
            isLoadingLogs = false;
        });
    }
    
    // Update pagination controls
    function updatePagination(pagination) {
        const paginationElement = document.getElementById('logsPagination');
        let paginationHtml = '<ul class="pagination justify-content-center">';
        
        // Previous button
        if (pagination.has_prev) {
            paginationHtml += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.prev_num}">Previous</a>
                </li>
            `;
        } else {
            paginationHtml += `
                <li class="page-item disabled">
                    <span class="page-link">Previous</span>
                </li>
            `;
        }
        
        // Page numbers
        // Simplified pagination for demo - in a real app you'd want more sophisticated pagination
        for (let i = 1; i <= Math.min(5, pagination.pages); i++) {
            if (i === pagination.page) {
                paginationHtml += `
                    <li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>
                `;
            } else {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
        }
        
        // Next button
        if (pagination.has_next) {
            paginationHtml += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.next_num}">Next</a>
                </li>
            `;
        } else {
            paginationHtml += `
                <li class="page-item disabled">
                    <span class="page-link">Next</span>
                </li>
            `;
        }
        
        paginationHtml += '</ul>';
        paginationElement.innerHTML = paginationHtml;
        
        // Note: Event listeners are already attached via event delegation in DOMContentLoaded
        // No need to reattach here as it causes multiple listeners and DOM node warnings
    }
    
    // Real-time User Activity Functions
    let usersUpdateInterval;
    
    function loadActiveUsers() {
        const refreshBtn = document.getElementById('refreshUsersBtn');
        refreshBtn.classList.add('loading');
        
        console.log('Loading active users...');
        
        // Get current filter values
        const statusFilter = document.getElementById('statusFilter').value;
        const branchFilter = document.getElementById('branchFilterUsers') ? document.getElementById('branchFilterUsers').value : '';
        const roleFilter = document.getElementById('roleFilter').value;
        
        // Build URL with filters
        const params = new URLSearchParams();
        if (statusFilter && statusFilter !== 'all') {
            params.append('status', statusFilter);
        }
        if (branchFilter) {
            params.append('branch_id', branchFilter);
        }
        if (roleFilter && roleFilter !== 'all') {
            params.append('role', roleFilter);
        }
        
        // Save filters to localStorage for persistence
        const filterState = {
            status: statusFilter,
            branch_id: branchFilter,
            role: roleFilter
        };
        localStorage.setItem('userActivityFilters', JSON.stringify(filterState));
        
        const url = '{{ url_for("superuser.active_users") }}' + (params.toString() ? '?' + params.toString() : '');
        console.log('Fetching URL:', url);
        
        fetch(url)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);
                if (data.success) {
                    updateUsersDisplay(data);
                    updateLastUpdated(data);
                } else {
                    console.error('Failed to load users:', data.error || data.message);
                    document.getElementById('usersGrid').innerHTML = 
                        `<div class="col-12 text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Error: ${data.error || 'Unknown error'}
                        </div>`;
                }
            })
            .catch(error => {
                console.error('Error loading users:', error);
                document.getElementById('usersGrid').innerHTML = 
                    `<div class="col-12 text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i> 
                        Failed to load user data: ${error.message}
                    </div>`;
            })
            .finally(() => {
                refreshBtn.classList.remove('loading');
            });
    }
    
    function updateUsersDisplay(data) {
        // Update statistics
        document.getElementById('onlineCount').textContent = data.online_users;
        document.getElementById('offlineCount').textContent = data.offline_users;
        document.getElementById('totalCount').textContent = data.total_users;
        document.getElementById('locationCount').textContent = 
            data.users.filter(u => u.location_data).length;
        
        // Update users grid
        const usersGrid = document.getElementById('usersGrid');
        if (data.users.length === 0) {
            usersGrid.innerHTML = '<div class="col-12 text-center text-muted">No users found</div>';
            return;
        }
        
        let html = '';
        data.users.forEach(user => {
            const statusClass = user.is_online ? 'online' : 'offline';
            const statusText = user.is_online ? 'Online' : 'Offline';
            const lastActivity = user.last_activity ? 
                new Date(user.last_activity).toLocaleString() : 'Never';
            
            const locationBtn = user.location_data ? 
                `<button class="btn btn-outline-info btn-sm location-btn" 
                         onclick="showLocationModal('${user.username}', '${user.ip_address}', ${JSON.stringify(user.location_data).replace(/"/g, '&quot;')})">
                    <i class="bi bi-geo-alt"></i> Location
                 </button>` : 
                `<span class="text-muted small">No location</span>`;
            
            html += `
                <div class="col-lg-4 col-md-6 mb-3">
                    <div class="card user-status-card ${statusClass}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="card-title mb-1">
                                        <span class="status-indicator ${statusClass}"></span>
                                        ${user.full_name || user.username}
                                    </h6>
                                    <small class="text-muted">@${user.username}</small>
                                </div>
                                <span class="badge bg-${user.is_online ? 'success' : 'secondary'}">${statusText}</span>
                            </div>
                            <div class="mb-2">
                                <small><strong>Role:</strong> ${user.role.replace('_', ' ')}</small><br>
                                <small><strong>Branch:</strong> ${user.branch_name}</small><br>
                                <small><strong>Last Activity:</strong> ${lastActivity}</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">IP: ${user.ip_address || 'N/A'}</small>
                                ${locationBtn}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        usersGrid.innerHTML = html;
    }
    
    function updateLastUpdated(data) {
        if (data && data.last_updated) {
            document.getElementById('lastUpdated').textContent = 
                `Updated: ${data.last_updated} (${data.timezone || 'UTC'})`;
        } else {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 
                `Updated: ${now.toLocaleTimeString()}`;
        }
    }
    
    function showLocationModal(username, ipAddress, locationData) {
        document.getElementById('locationModalTitle').textContent = `Location for ${username}`;
        document.getElementById('locationIP').textContent = ipAddress;
        document.getElementById('locationCountry').textContent = locationData.country;
        document.getElementById('locationRegion').textContent = locationData.region;
        document.getElementById('locationCity').textContent = locationData.city;
        document.getElementById('locationPostal').textContent = locationData.postal || 'N/A';
        document.getElementById('locationISP').textContent = locationData.isp;
        document.getElementById('locationTimezone').textContent = locationData.timezone;
        document.getElementById('locationAddress').textContent = locationData.address;
        
        // Initialize map
        if (locationData.latitude && locationData.longitude) {
            initializeMap(locationData.latitude, locationData.longitude, locationData.address);
        }
        
        // Show modal
        new bootstrap.Modal(document.getElementById('locationModal')).show();
    }
    
    function initializeMap(lat, lng, address) {
        // Remove existing map
        const mapContainer = document.getElementById('locationMap');
        mapContainer.innerHTML = '';
        
        // Create map using Leaflet (free alternative to Google Maps)
        const map = L.map('locationMap').setView([lat, lng], 13);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add marker
        L.marker([lat, lng])
            .addTo(map)
            .bindPopup(address)
            .openPopup();
    }
    
    // Initialize real-time updates - moved to main DOMContentLoaded handler above
    // This ensures filters are restored before loading user data
    
    // Clean up interval when page unloads
    window.addEventListener('beforeunload', function() {
        if (usersUpdateInterval) {
            clearInterval(usersUpdateInterval);
        }
    });
    
    // Initialize the existing audit logs functionality first
    loadLogs(1);
    
    // Initialize user activity filters
    initializeUserActivityFilters();
    
    // Add event listeners for user activity filters
    document.getElementById('applyUserFilters').addEventListener('click', function() {
        loadActiveUsers();
    });
    
    // Auto-apply filters when dropdowns change
    document.getElementById('statusFilter').addEventListener('change', loadActiveUsers);
    if (document.getElementById('branchFilterUsers')) {
        document.getElementById('branchFilterUsers').addEventListener('change', loadActiveUsers);
    }
    document.getElementById('roleFilter').addEventListener('change', loadActiveUsers);
    
    // Initialize user activity monitoring after filters are restored
    console.log('DOM loaded, initializing user activity monitoring...');
    
    // Test if the route is accessible first
    fetch('{{ url_for("superuser.test_route") }}')
        .then(response => response.json())
        .then(data => {
            console.log('Test route response:', data);
            // If test route works, load users with restored filters
            loadActiveUsers();
            
            // Set up auto-refresh every 30 seconds
            usersUpdateInterval = setInterval(loadActiveUsers, 30000);
        })
        .catch(error => {
            console.error('Test route failed:', error);
            document.getElementById('usersGrid').innerHTML = 
                `<div class="col-12 text-center text-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    Route test failed: ${error.message}
                </div>`;
        });
    
    // Manual refresh button
    document.getElementById('refreshUsersBtn').addEventListener('click', loadActiveUsers);
});

// Function to initialize and restore user activity filters
function initializeUserActivityFilters() {
    try {
        const savedFilters = localStorage.getItem('userActivityFilters');
        if (savedFilters) {
            const filters = JSON.parse(savedFilters);
            
            // Restore filter values
            if (filters.status) {
                document.getElementById('statusFilter').value = filters.status;
            }
            if (filters.branch_id && document.getElementById('branchFilterUsers')) {
                document.getElementById('branchFilterUsers').value = filters.branch_id;
            }
            if (filters.role) {
                document.getElementById('roleFilter').value = filters.role;
            }
            
            console.log('Restored filters:', filters);
        }
    } catch (error) {
        console.error('Error restoring user activity filters:', error);
    }
}

// Separate script block for user activity monitoring
</script>
<script>
// This script block has been consolidated into the main script above
</script>

<!-- Location Modal -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="locationModalTitle">User Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-info-circle me-2"></i>Location Details</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>IP Address:</strong></td>
                                <td id="locationIP">-</td>
                            </tr>
                            <tr>
                                <td><strong>Country:</strong></td>
                                <td id="locationCountry">-</td>
                            </tr>
                            <tr>
                                <td><strong>Region:</strong></td>
                                <td id="locationRegion">-</td>
                            </tr>
                            <tr>
                                <td><strong>City:</strong></td>
                                <td id="locationCity">-</td>
                            </tr>
                            <tr>
                                <td><strong>Postal Code:</strong></td>
                                <td id="locationPostal">-</td>
                            </tr>
                            <tr>
                                <td><strong>ISP:</strong></td>
                                <td id="locationISP">-</td>
                            </tr>
                            <tr>
                                <td><strong>Timezone:</strong></td>
                                <td id="locationTimezone">-</td>
                            </tr>
                        </table>
                        <div class="alert alert-info">
                            <small><i class="bi bi-geo-alt me-1"></i><strong>Address:</strong> <span id="locationAddress">-</span></small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-map me-2"></i>Map Location</h6>
                        <div id="locationMap" style="height: 300px; border-radius: 8px;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Include Leaflet CSS and JS for maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}