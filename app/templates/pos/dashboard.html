{% extends "base.html" %}

{% block title %}Cashier Dashboard - Restaurant POS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Cashier Dashboard</h1>
        <p class="text-muted">Welcome, {{ current_user.get_full_name() }}!</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Total Orders</h5>
                        <h2>{{ total_orders }}</h2>
                        <small>All Time</small>
                    </div>
                    <i class="bi bi-receipt" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Today's Sales</h5>
                        <h2>{{ "%.2f"|format(today_sales) }} QAR</h2>
                        <small>{{ today_orders }} orders</small>
                    </div>
                    <i class="bi bi-currency-dollar" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Today's Orders</h5>
                        <h2>{{ today_orders }}</h2>
                        <small>{{ "%.2f"|format(today_sales/today_orders if today_orders > 0 else 0) }} QAR avg</small>
                    </div>
                    <i class="bi bi-cart-check" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Total Revenue</h5>
                        <h2>{{ "%.0f"|format(total_revenue) }}</h2>
                        <small>QAR All Time</small>
                    </div>
                    <i class="bi bi-piggy-bank" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Waiter Statistics Section (Only for Cashiers) -->
{% if current_user.role.value == 'cashier' and waiter_stats %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person-badge"></i> Waiter Orders Today
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-receipt text-warning" style="font-size: 2rem;"></i>
                                <h4 class="mt-2">{{ waiter_stats.orders_today }}</h4>
                                <small class="text-muted">Orders from Waiters</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-currency-dollar text-success" style="font-size: 2rem;"></i>
                                <h4 class="mt-2">{{ "%.2f"|format(waiter_stats.sales_today) }}</h4>
                                <small class="text-muted">QAR Paid Sales</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-clock text-warning" style="font-size: 2rem;"></i>
                                <h4 class="mt-2">{{ waiter_stats.pending_orders }}</h4>
                                <small class="text-muted">Pending Payment</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <a href="{{ url_for('pos.orders') }}" class="btn btn-warning btn-lg">
                                    <i class="bi bi-list-check"></i> View Orders
                                </a>
                                <small class="d-block text-muted mt-1">Manage Payments</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Note:</strong> Waiter orders appear as "Pending" until you mark them as "Paid" when customers complete payment. 
                            Only paid orders count toward revenue statistics.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Print Report Section -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-earmark-pdf"></i> Daily Report
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6>üìã End of Shift Report</h6>
                        <p class="mb-0">Generate your daily performance report for management review. This report includes today's sales, orders, and 7-day performance trends.</p>
                        <small class="text-muted">‚ö†Ô∏è Required before logout</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="printReportBtn" class="btn btn-danger btn-lg">
                            <i class="bi bi-printer"></i> Print Daily Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Sales Trend (Last 7 Days)</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('pos.index') }}" class="btn btn-primary btn-lg">
                        <i class="bi bi-cash-register"></i> Back to POS
                    </a>
                    <a href="{{ url_for('pos.orders') }}" class="btn btn-info btn-lg">
                        <i class="bi bi-list-ul"></i> My Orders
                    </a>
                    <button id="refreshStatsBtn" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Stats
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Orders</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Table</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Service</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr data-order-id="{{ order.id }}">
                                <td>{{ order.order_number }}</td>
                                <td>{{ order.table.table_number if order.table else 'N/A' }}</td>
                                <td>
                                    {% set regular_items = [] %}
                                    {% for item in order.order_items %}
                                        {% if 'ÿ∑ŸÑÿ®ÿßÿ™ ÿÆÿßÿµÿ©' not in item.menu_item.name %}
                                            {% set _ = regular_items.append(item) %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="badge bg-info">{{ regular_items | length }}</span>
                                </td>
                                <td>{{ "%.2f"|format(order.total_amount) }} QAR</td>
                                <td>
                                    {% if order.service_type %}
                                        {% if order.service_type.value == 'on_table' %}
                                            <span class="badge bg-primary">On Table</span>
                                        {% elif order.service_type.value == 'take_away' %}
                                            <span class="badge bg-warning">Take Away</span>
                                        {% elif order.service_type.value == 'delivery' %}
                                            <span class="badge bg-info">Delivery</span>
                                            {% if order.delivery_company %}
                                                <br><small class="text-muted">{{ order.delivery_company.value.title() }}</small>
                                            {% endif %}
                                        {% elif order.service_type.value == 'card' %}
                                            <span class="badge bg-success">Card Payment</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ order.service_type.value.replace('_', ' ').title() }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>{{ order.created_at.strftime('%H:%M') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary view-order" data-order-id="{{ order.id }}">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sales chart - only initialize if we have data
    const salesChartElement = document.getElementById('salesChart');
    if (salesChartElement) {
        const ctx = salesChartElement.getContext('2d');
        // Sample data for the chart
        const salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [
                    {% for sale in daily_sales %}
                    '{{ sale.date }}',
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Daily Sales (QAR)',
                    data: [
                        {% for sale in daily_sales %}
                        {{ sale.total }},
                        {% endfor %}
                    ],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Print daily report functionality
    document.getElementById('printReportBtn').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating Report...';
        
        // Open daily report in new window - PDF generation now automatically marks as printed
        const reportWindow = window.open('/pos/daily_report', '_blank');
        
        // Re-enable button after a short delay
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-printer"></i> Print Daily Report';
            showNotification('Daily report generated and marked as printed. You can now logout safely.');
        }, 2000);
        
        // Fallback: Also call the mark endpoint for redundancy (in case PDF generation fails)
        setTimeout(() => {
            fetch('/pos/mark_daily_report_printed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Daily report status confirmed on server');
                } else {
                    console.log('Report already marked or error:', data.error);
                }
            })
            .catch(error => {
                console.log('Backup marking call failed (likely already marked):', error);
            });
        }, 1000);
    });
    
    // Refresh stats functionality
    document.getElementById('refreshStatsBtn').addEventListener('click', function() {
        location.reload();
    });
    
    // View order details
    document.querySelectorAll('.view-order').forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            viewOrder(orderId);
        });
    });
    
    // Connect to SocketIO
    const socket = io();
    
    // Listen for order status updates
    socket.on('order_status_updated', function(data) {
        // Update the status badge in the recent orders table
        const statusBadge = document.querySelector(`tr[data-order-id="${data.order_id}"] .badge`);
        if (statusBadge) {
            // Update badge color based on new status
            let badgeClass = 'bg-secondary';
            if (data.new_status === 'pending') {
                badgeClass = 'bg-primary';
            } else if (data.new_status === 'in_progress') {
                badgeClass = 'bg-warning';
            } else if (data.new_status === 'ready') {
                badgeClass = 'bg-success';
            }
            
            statusBadge.className = `badge ${badgeClass}`;
            statusBadge.textContent = data.new_status.replace('_', ' ').toUpperCase();
        }
        
        // Show notification
        showNotification(`Order ${data.order_number} status updated to ${data.new_status.replace('_', ' ')}`);
    });
    
    function showNotification(message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
        notification.style = 'top: 20px; right: 20px; z-index: 9999;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
});

function viewOrder(orderId) {
    fetch(`/pos/get_order_details/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Create invoice HTML
                let itemsHtml = '';
                data.items.forEach(item => {
                    itemsHtml += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>${parseFloat(item.unit_price).toFixed(2)} QAR</td>
                            <td>${parseFloat(item.total_price).toFixed(2)} QAR</td>
                        </tr>
                    `;
                });
                
                const invoiceHtml = `
                    <div class="container invoice-container">
                        <div class="invoice-header text-center mb-4">
                            <h3>Restaurant POS</h3>
                            <h4>Invoice</h4>
                            <p>Order #${data.order_number}</p>
                            <p>${new Date(data.created_at).toLocaleString()}</p>
                        </div>
                        
                        <div class="mb-3">
                            <p><strong>Cashier:</strong> ${data.cashier_name || 'N/A'}</p>
                            <p><strong>Table:</strong> ${data.table_number || 'N/A'}</p>
                        </div>
                        
                        <div class="table-responsive mb-3">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="text-end mb-4">
                            <h4>Total: ${parseFloat(data.total_amount).toFixed(2)} QAR</h4>
                        </div>
                        
                        <div class="text-center">
                            <p class="small">Thank you for your business!</p>
                        </div>
                    </div>
                `;
                
                // Open invoice in new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Invoice - ${data.order_number}</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <style>
                            @media print {
                                body {
                                    font-size: 12px;
                                    padding: 0;
                                    margin: 0;
                                }
                                
                                .invoice-container {
                                    max-width: 80mm;
                                    margin: 0 auto;
                                }
                                
                                .btn, .no-print {
                                    display: none !important;
                                }
                            }
                            
                            body {
                                font-family: Arial, sans-serif;
                            }
                            
                            .invoice-header {
                                text-align: center;
                                border-bottom: 2px solid #000;
                                padding-bottom: 10px;
                                margin-bottom: 15px;
                            }
                            
                            .text-right {
                                text-align: right;
                            }
                            
                            .text-center {
                                text-align: center;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container invoice-container">
                            ${invoiceHtml}
                            <div class="text-center no-print mt-3">
                                <button class="btn btn-primary" onclick="window.print()">
                                    <i class="bi bi-printer"></i> Print Invoice
                                </button>
                                <button class="btn btn-secondary" onclick="window.close()">
                                    <i class="bi bi-x-circle"></i> Close
                                </button>
                            </div>
                        </div>
                        <script>
                            // Auto-print when page loads (for POS systems)
                            window.onload = function() {
                                window.print();
                            }
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while loading order details');
        });
}
</script>
{% endblock %}